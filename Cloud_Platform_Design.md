# T8000 多租户云平台设计文档 (Cloud Platform Design)

## 1. 核心愿景 (Vision)
从单一设备的嵌入式管理工具，转型为**以数据为核心**的**多租户物联网 SaaS 平台**。
核心原则：
*   **多租户 (Multi-tenancy)**：不同公司数据严格隔离。
*   **一致性 (Consistency)**：保留现有单机版 UI 体验，作为云平台的“设备详情”视图。
*   **全局视野 (Global View)**：提供跨设备的监控、聚合与报警管理。

---

## 2. 层级结构 (Hierarchy)

为了适应“学校-楼宇-设备”的场景，采用三层结构：

1.  **Tenant (租户/组织)**
    *   *定义*：购买服务的公司或机构（如：新加坡国立大学）。
    *   *权限*：数据完全隔离，拥有独立的管理员和用户体系。
2.  **Site / Project (站点/项目)**
    *   *定义*：地理位置或逻辑分组（如：一号教学楼、东区食堂）。
    *   *功能*：设备的容器，用于批量管理和报警分发。
3.  **Gateway (网关/T8000)**
    *   *定义*：物理 T8000 主机。
    *   *功能*：连接传感器，执行本地逻辑。
4.  **Sub-device / Sensor (子设备/传感器)**
    *   *定义*：挂载在 T8000 下的 Modbus 设备。

---

## 3. 功能清单 (Feature List)

### A. 云平台全局层 (The Cloud Layer)
*专注于全局监控与资源管理*

#### 1. 全局仪表盘 (Global Dashboard)
*   **GIS 地图视图**：
    *   显示所有 Site/Gateway 的地理位置。
    *   状态颜色区分：🟢正常 / 🔴报警 / ⚫离线。
*   **关键指标卡片**：
    *   全网设备在线率。
    *   今日总报警数。
    *   聚合能耗数据（如：所有站点的总用电量）。

#### 2. 全局数据监控 (Global Monitor) - *核心差异化功能*
*   **关注列表 (Pinned Sensors)**：
    *   用户可在设备详情页将关键传感器（如“核心机房温度”）“钉”到首页。
    *   实现跨设备的关键数据同屏展示。
*   **异常排行 (Top N)**：
    *   自动列出数值最高/最低的传感器（如：温度最高的5个房间）。
*   **虚拟传感器 (Virtual Sensors)**：
    *   云端计算字段，例如 `Total_Power = Device_A.Power + Device_B.Power`。

#### 3. 全局报警中心 (Global Alarm Center)
*   **统一报警流**：按时间轴展示所有设备的报警记录。
*   **通知策略**：配置邮件、短信、Webhook 推送规则（按 Site 或 Tenant 分组）。

#### 4. 设备入网 (Provisioning)
*   **设备认领**：通过序列号 (S/N) 或二维码将 T8000 绑定到指定 Tenant/Site。

---

### B. 设备孪生层 (The Device Layer)
*复用现有 T8000 GUI 设计，保持用户习惯*

当用户在全局层点击某台设备时，进入此视图：
*   **Monitor**：查看该设备下所有传感器的实时数据列表。
*   **Analysis**：查看历史数据曲线（数据源切换为云端数据库）。
*   **Alarms**：查看该设备的本地报警历史。
*   **Rules/Settings**：远程配置设备参数（通过 MQTT 下发指令）。

---

## 4. 用户角色 (User Roles)

1.  **Platform Admin (平台超级管理员)**
    *   管理所有 Tenant，系统维护。
2.  **Tenant Admin (租户管理员)**
    *   创建 Site，添加 Gateway，管理本公司员工账号。
3.  **Site Operator (站点运维)**
    *   查看分配给自己的 Site，处理报警，远程控制设备。
4.  **Viewer (只读用户)**
    *   仅查看数据，不可修改配置。

---

## 5. 技术架构关键点

*   **前端 (Frontend)**
    *   **Shell 架构**：外层是 Cloud Shell（菜单、地图），内层嵌入 Device UI。
    *   **Context 切换**：API 请求需携带 `tenant_id` 和 `device_id` 上下文。
*   **后端 (Backend)**
    *   **MQTT Broker**：处理海量设备长连接与数据上报。
    *   **Time-series DB**：存储历史传感器数据（Analysis 页面使用）。
    *   **Digital Twin**：云端维护一份设备的“影子状态”，前端读取影子而非直接连接设备。
